<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Lector Japon√©s - Comparativo y Voz</title>

  <!-- ============================================
       Librer√≠as locales/external necesarias
       - PDF.js (CDN)
       - JSZip / epub.js (CDN)
       - kuromoji.js (LOCAL -> js/kuromoji.js)
       ============================================ -->

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
  <script>
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js";
    }
  </script>

  <!-- JSZip / epub.js desde CDN (puedes cambiar si quieres local) -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.7.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

  <!-- kuromoji.js local: coloca js/kuromoji.js en tu repo -->
  <script id="kuromoji-script" src="js/kuromoji.js"></script>
  <script>
    // Promise que se resuelve cuando kuromoji est√° cargado y listo
    window.kuromojiReady = new Promise((resolve, reject) => {
      const s = document.getElementById("kuromoji-script");
      // si ya carg√≥ y defini√≥ window.kuromoji
      if (window.kuromoji && typeof window.kuromoji.builder === "function") {
        console.log("‚úÖ kuromoji.js ya disponible");
        return resolve(window.kuromoji);
      }
      // escuchar evento load/error
      s.addEventListener("load", () => {
        if (window.kuromoji && typeof window.kuromoji.builder === "function") {
          console.log("‚úÖ kuromoji.js cargado correctamente");
          resolve(window.kuromoji);
        } else {
          reject(new Error("kuromoji se carg√≥, pero window.kuromoji no est√° disponible"));
        }
      });
      s.addEventListener("error", () => {
        reject(new Error("No se pudo cargar js/kuromoji.js"));
      });
      // por si el script se descarga inmediatamente despu√©s de crear la promesa
      setTimeout(() => {
        if (window.kuromoji && typeof window.kuromoji.builder === "function") {
          resolve(window.kuromoji);
        }
      }, 50);
    });

    async function waitForKuromoji() {
      return await window.kuromojiReady;
    }
  </script>

  <!-- ============================================
       Estilos
       (versi√≥n moderna, adaptativa)
       ============================================ -->
  <style>
    :root{
      --bg:#fbfbfd;--panel:#fff;--muted:#6b7280;--accent:#6c8cff;--border:#e6e9ef;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui, -apple-system, "Helvetica Neue", Arial;color:#111827}
    h1.page-title{margin:12px 20px;font-size:1.18rem;font-weight:700}
    #top-bar{display:flex;gap:1rem;align-items:center;padding:14px 20px;border-bottom:1px solid var(--border);background:var(--panel);position:sticky;top:0;z-index:50}
    #container{display:flex;gap:12px;padding:18px;height:calc(100vh - 25vh - 120px)}
    #text1,#text2{width:50%;padding:18px;overflow-y:auto;background:var(--panel);border:1px solid var(--border);border-radius:10px;line-height:1.9;font-size:1.05rem;min-height:120px;white-space:pre-wrap}
    ruby rt{font-size:.65em;color:#374151;font-weight:600}
    .sentence{display:inline;padding:2px 6px;border-radius:6px;cursor:text}
    .sentence.active-sentence{background:rgba(108,140,255,0.12)}
    .sentence-es{display:inline;padding:2px 6px;border-radius:6px}
    .sentence-es.active-sentence-es{background:rgba(102,204,255,0.12)}
    #bottom-bar{position:fixed;bottom:0;left:0;width:100%;height:25vh;display:flex;gap:12px;border-top:1px solid var(--border);background:rgba(255,255,255,0.96);z-index:60;padding:12px;align-items:center}
    #voice-panel{width:18%;min-width:180px;border-right:1px solid var(--border);padding-right:12px;display:flex;flex-direction:column;gap:8px}
    #compare-panel{flex:1;display:flex;flex-direction:column;gap:8px;align-items:center}
    #jp-sentence{width:95%;text-align:center;font-size:1.08rem;font-weight:600;color:#07103a}
    #es-sentence{width:95%;text-align:center;font-size:.98rem;color:var(--muted);min-height:2.4em}
    .icon{background:linear-gradient(180deg,#fff,#f6f9ff);border:1px solid var(--border);padding:6px 10px;border-radius:8px;cursor:pointer}
    .lexword{position:relative;padding:0 2px;border-radius:4px}
    .lexword:hover{background:rgba(255,208,138,0.14)}
    .tooltip{position:absolute;bottom:130%;left:50%;transform:translateX(-50%);background:#0b1220;color:#fff;padding:6px 8px;border-radius:6px;font-size:.85rem;box-shadow:0 6px 18px rgba(2,6,23,.3);white-space:nowrap;z-index:9999;opacity:0;pointer-events:none;transition:opacity .12s,transform .12s}
    .lexword.show-tooltip .tooltip{opacity:1;transform:translateX(-50%) translateY(-4px);pointer-events:auto}
    @media(max-width:900px){#container{flex-direction:column;height:calc(50vh - 72px)}#text1,#text2{width:100%}#voice-panel{width:30%}}
    #debug{position:fixed;top:12px;right:12px;background:rgba(0,0,0,0.7);color:#fff;padding:8px 10px;border-radius:6px;font-size:12px;z-index:2000;display:none}
  </style>
</head>
<body>
  <h1 class="page-title">Lector Japon√©s - Comparativo y Voz</h1>

  <div id="top-bar">
    <div><label for="file1">üìò Texto japon√©s:</label><input id="file1" type="file" accept=".txt,.pdf,.epub"></div>
    <div><label for="file2">üìô Texto espa√±ol:</label><input id="file2" type="file" accept=".txt,.pdf,.epub"></div>
    <div style="margin-left:auto;color:var(--muted);font-size:.95rem">Tips: selecciona voz y usa A/D/S/Espacio</div>
  </div>

  <div id="container">
    <div id="text1">Cargar texto japon√©s aqu√≠‚Ä¶</div>
    <div id="text2">Cargar texto espa√±ol aqu√≠‚Ä¶</div>
  </div>

  <div id="bottom-bar">
    <div id="voice-panel">
      <label for="voiceSelect" style="font-weight:700">Voz:</label>
      <select id="voiceSelect"></select>
      <label for="speedRange" style="margin-top:6px;font-weight:700">Velocidad:</label>
      <input id="speedRange" type="range" min="0.5" max="2" step="0.1" value="1">
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="playBtn" class="icon">‚ñ∂Ô∏é</button>
        <button id="pauseBtn" class="icon">‚è∏Ô∏é</button>
        <button id="stopBtn" class="icon">‚ñ†</button>
      </div>
      <div style="font-size:.85rem;color:var(--muted);margin-top:6px">Ajusta la velocidad para TTS</div>
    </div>

    <div id="compare-panel">
      <div id="jp-sentence">ÔºàOraci√≥n japonesa aparecer√° aqu√≠Ôºâ</div>
      <div id="es-sentence">ÔºàTraducci√≥n en espa√±ol aparecer√° aqu√≠Ôºâ</div>
      <div id="nav-buttons" style="width:95%;display:flex;justify-content:flex-end;gap:8px">
        <button id="prev-translation" class="icon" title="Anterior">‚óÄ</button>
        <button id="next-translation" class="icon" title="Siguiente">‚ñ∂</button>
        <button id="explain-jp" class="icon" title="Explicar oraci√≥n">üí¨</button>
      </div>
    </div>
  </div>

  <div id="debug">debug</div>

  <!-- ============================================
       SCRIPT PRINCIPAL (todo en este index.html)
       ============================================ -->
  <script>
  /* ========================
     Mini-diccionario offline (puedes ampliarlo)
     ======================== */
  const miniDict = {
    "ÁßÅ": "yo","ÁßÅ„Åü„Å°":"nosotros","Ë°å„Åè":"ir","Ë°å„Åç„Åæ„Åô":"ir (formal)","Ë°å„Å£„Åü":"ir (pasado)",
    "Ë¶ã„Çã":"ver","È£ü„Åπ„Çã":"comer","Â§ß„Åç„ÅÑ":"grande","Â∞è„Åï„ÅÑ":"peque√±o","Áå´":"gato","Áä¨":"perro",
    "Êñ∞„Åó„ÅÑ":"nuevo","Âè§„ÅÑ":"viejo","Êú¨":"libro","Â≠¶Ê†°":"escuela","ÂÖàÁîü":"profesor","Â≠¶Áîü":"estudiante",
    "Â•Ω„Åç":"gustar","È´ò„ÅÑ":"caro / alto","ÂÆâ„ÅÑ":"barato","Êù•„Çã":"venir","Ë®Ä„ÅÜ":"decir"
  };

  /* ========================
     Estado global
     ======================== */
  let kuromojiTokenizer = null;
  let sentences = [];
  let allEsSentences = [];
  let currentSentence = 0;
  let translationIndex = 0;
  let isPaused = false;
  const synth = window.speechSynthesis;
  let voices = [];
  const voiceSelect = document.getElementById("voiceSelect");
  const rateInput = document.getElementById("speedRange");

  /* ========================
     Inicializar Kuromoji (usa dic local: ./dict/)
     ======================== */
  async function initKuromoji(retries = 2) {
    console.log("‚è≥ Esperando que kuromoji est√© disponible...");
    try {
      await waitForKuromoji(); // espera a la promesa creada en head
    } catch (e) {
      console.error("‚ùå Kuromoji no se carg√≥:", e);
      throw e;
    }

    return new Promise((resolve, reject) => {
      if (kuromojiTokenizer) return resolve(kuromojiTokenizer);

      try {
        // dicPath apunta a la carpeta dict/ en el repo
        kuromoji.builder({ dicPath: "./dict/" }).build((err, tokenizer) => {
          if (err) {
            console.warn("‚ö†Ô∏è Error al construir tokenizador:", err);
            if (retries > 0) {
              console.log(`üîÅ Reintentando initKuromoji (${retries-1} left)`);
              setTimeout(() => initKuromoji(retries - 1).then(resolve).catch(reject), 900);
            } else {
              reject(err);
            }
            return;
          }
          kuromojiTokenizer = tokenizer;
          console.log("‚úÖ Kuromoji inicializado correctamente (dic local).");
          resolve(tokenizer);
        });
      } catch (e) {
        console.error("üí• Excepci√≥n en initKuromoji:", e);
        reject(e);
      }
    });
  }

  /* ========================
     Utilidades
     ======================== */
  function containsKanji(str) {
    return /[‰∏Ä-ÈæØ]/.test(str);
  }
  function kanaKatakanaToHiragana(str) {
    return str.replace(/[\u30a1-\u30f6]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0x60));
  }
  function escapeHtml(s) {
    return ("" + s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  function escapeAttr(s) {
    return ("" + s).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
  }

  /* ========================
     Lectura de archivos: txt / pdf / epub
     ======================== */
  async function readFile(file) {
    const ext = (file.name || "").split('.').pop().toLowerCase();
    if (ext === "txt") {
      return await file.text();
    } else if (ext === "pdf") {
      try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let text = "";
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          text += content.items.map(it => it.str).join(' ') + "\n";
        }
        return text;
      } catch (e) {
        console.error("Error leyendo PDF:", e);
        return "";
      }
    } else if (ext === "epub") {
      try {
        const book = ePub(await file.arrayBuffer());
        const spine = await book.loaded.spine;
        let text = "";
        for (const item of spine) {
          try {
            const content = await book.load(item.href);
            text += new TextDecoder("utf-8").decode(content);
          } catch (err) {
            console.warn("Error leyendo item EPUB:", err);
          }
        }
        return text.replace(/<[^>]+>/g, ' ');
      } catch (e) {
        console.error("Error leyendo EPUB:", e);
        return "";
      }
    } else {
      alert("Formato no soportado: " + ext);
      return "";
    }
  }

  /* ========================
     Segmentaci√≥n + Furigana
     ======================== */
  async function processJapaneseRaw(raw) {
    try {
      await initKuromoji();
    } catch (err) {
      console.warn("Kuromoji no disponible, continuar√° sin furigana:", err);
    }

    raw = (raw || "").replace(/\r/g, "\n").trim();

    // segmentaci√≥n robusta sin lookbehind
    const parts = raw.split(/([„ÄÇÔºÅÔºü?!\n]+)/u)
      .reduce((acc, cur) => {
        if (/^[„ÄÇÔºÅÔºü?!\n]+$/.test(cur)) {
          if (acc.length === 0) acc.push(cur);
          else acc[acc.length - 1] += cur;
        } else {
          acc.push(cur);
        }
        return acc;
      }, [])
      .map(p => p.trim())
      .filter(Boolean);

    const processed = [];

    for (const part of parts) {
      if (!kuromojiTokenizer) {
        processed.push(escapeHtml(part));
        continue;
      }

      const tokens = kuromojiTokenizer.tokenize(part);
      const htmlPieces = tokens.map(t => {
        const surface = t.surface_form || "";
        const reading = t.reading || "";
        const basic = t.basic_form || surface;
        const pos = t.pos || "";

        let display = escapeHtml(surface);
        if (containsKanji(surface) && reading) {
          const hira = kanaKatakanaToHiragana(reading);
          display = `<ruby>${escapeHtml(surface)}<rt>${escapeHtml(hira)}</rt></ruby>`;
        }

        const isLex = (pos === "ÂêçË©û" || pos === "ÂãïË©û" || pos === "ÂΩ¢ÂÆπË©û");
        if (isLex) {
          const lemma = escapeAttr(basic === "*" ? surface : basic);
          const posAttr = escapeAttr(pos);
          return `<span class="lexword" data-lemma="${lemma}" data-pos="${posAttr}">${display}<span class="tooltip"></span></span>`;
        } else {
          return display;
        }
      });

      processed.push(htmlPieces.join(""));
    }

    return processed;
  }

  /* ========================
     Renderizado
     ======================== */
  async function renderJapaneseFromRaw(raw) {
    const container = document.getElementById("text1");
    const processed = await processJapaneseRaw(raw);
    container.innerHTML = processed.map((p, i) => `<span class="sentence" data-index="${i}">${p}</span>`).join(" ");
    sentences = Array.from(container.querySelectorAll(".sentence"));
    attachTooltipEvents();
  }

  function renderSpanishFromRaw(raw) {
    const container = document.getElementById("text2");
    const parts = raw.split(/([„ÄÇ.!?ÔºÅÔºü\n]+)/u)
      .reduce((acc, cur) => {
        if (/^[„ÄÇ.!?ÔºÅÔºü\n]+$/.test(cur)) {
          if (acc.length === 0) acc.push(cur);
          else acc[acc.length - 1] += cur;
        } else acc.push(cur);
        return acc;
      }, [])
      .map(p => p.trim())
      .filter(Boolean);

    container.innerHTML = parts.map((p, i) => `<span class="sentence-es" data-index="${i}">${escapeHtml(p)}</span>`).join(" ");
    allEsSentences = Array.from(container.querySelectorAll(".sentence-es"));
  }

  /* ========================
     Tooltips
     ======================== */
  function attachTooltipEvents() {
    document.querySelectorAll(".lexword").forEach(node => {
      node.onmouseenter = null; node.onmouseleave = null; node.onclick = null;
      node.addEventListener("mouseenter", onLexEnter);
      node.addEventListener("mouseleave", onLexLeave);
      node.addEventListener("click", onLexClick);
    });
  }
  function onLexEnter(e) { showTooltipFor(e.currentTarget); }
  function onLexLeave(e) { hideTooltipFor(e.currentTarget); }
  function onLexClick(e) { const node = e.currentTarget; showTooltipFor(node); setTimeout(()=>hideTooltipFor(node),2500); }

  function showTooltipFor(node) {
    const lemma = node.dataset.lemma || node.textContent.trim();
    let text = miniDict[lemma] || miniDict[node.textContent.trim()] || null;
    if (!text) {
      const rt = node.querySelector("rt");
      if (rt) text = `Lectura: ${rt.textContent}`;
      else text = "sin traducci√≥n (diccionario offline limitado)";
    }
    const tooltip = node.querySelector(".tooltip");
    if (tooltip) { tooltip.textContent = text; node.classList.add("show-tooltip"); }
  }
  function hideTooltipFor(node) { const tooltip = node.querySelector(".tooltip"); if (tooltip) tooltip.textContent = ""; node.classList.remove("show-tooltip"); }

  /* ========================
     TTS (Web Speech API)
     ======================== */
  function populateVoices() {
    voices = synth.getVoices().filter(v => v.lang && v.lang.startsWith("ja"));
    if (!voices.length) voices = synth.getVoices() || [];
    voiceSelect.innerHTML = "";
    voices.forEach(v => { const opt = document.createElement("option"); opt.value = v.name; opt.textContent = `${v.name} (${v.lang})`; voiceSelect.appendChild(opt); });
  }
  populateVoices();
  speechSynthesis.onvoiceschanged = populateVoices;

  function extractPlainText(element) {
    const clone = element.cloneNode(true);
    clone.querySelectorAll("rt, .tooltip").forEach(n => n.remove());
    return clone.innerText.trim();
  }

  function speakSentence(index) {
    if (!sentences.length) return;
    if (!voices.length) populateVoices();
    const el = sentences[index]; if (!el) return;
    const sentence = extractPlainText(el);
    synth.cancel();
    const u = new SpeechSynthesisUtterance(sentence);
    u.voice = voices.find(v=>v.name===voiceSelect.value) || voices[0];
    u.rate = parseFloat(rateInput.value) || 1;
    u.lang = "ja-JP";
    highlightSentence(index);
    u.onend = ()=>{ if(!isPaused && index < sentences.length-1){ currentSentence++; speakSentence(currentSentence); } };
    synth.speak(u);
  }

  /* ========================
     Resaltado y comparativo
     ======================== */
  function highlightSentence(index) {
    sentences.forEach(s=>s.classList.remove("active-sentence"));
    allEsSentences.forEach(s=>s.classList.remove("active-sentence-es"));
    if (sentences[index]) { sentences[index].classList.add("active-sentence"); sentences[index].scrollIntoView({behavior:"smooth",block:"center"}); }
    if (allEsSentences[translationIndex]) { allEsSentences[translationIndex].classList.add("active-sentence-es"); allEsSentences[translationIndex].scrollIntoView({behavior:"smooth",block:"center"}); }
    updateComparePanel(index);
  }
  function updateComparePanel(index) {
    const jp = sentences[index]; const es = allEsSentences[translationIndex];
    document.getElementById("jp-sentence").innerHTML = jp ? jp.innerHTML : "ÔºàOraci√≥n japonesa aparecer√° aqu√≠Ôºâ";
    document.getElementById("es-sentence").textContent = es ? es.innerText : "ÔºàTraducci√≥n en espa√±ol aparecer√° aqu√≠Ôºâ";
  }

  /* ========================
     Controls: play/pause/next/prev
     ======================== */
  function playPause() {
    if (synth.speaking && !isPaused) { try{ synth.pause(); }catch(e){}; isPaused=true; }
    else if (isPaused) { try{ synth.resume(); }catch(e){}; isPaused=false; }
    else { if(!sentences.length){ renderSpanishFromRaw(document.getElementById("text2").innerText||""); renderJapaneseFromRaw(document.getElementById("text1").innerText||""); } currentSentence=0; isPaused=false; speakSentence(currentSentence); }
  }
  function nextSentence(){ if(currentSentence < sentences.length-1){ currentSentence++; synth.cancel(); speakSentence(currentSentence); } }
  function prevSentence(){ if(currentSentence > 0){ currentSentence--; synth.cancel(); speakSentence(currentSentence); } }
  function repeatSentence(){ synth.cancel(); speakSentence(currentSentence); }

  /* ========================
     Eventos de interacci√≥n (clicks y teclado)
     ======================== */
  document.getElementById("text1").addEventListener("click", e=>{
    const clicked = e.target.closest(".sentence"); if(!clicked) return; const idx = sentences.indexOf(clicked); if(idx!==-1){ currentSentence=idx; highlightSentence(idx); speakSentence(idx); }
  });
  document.getElementById("prev-translation").addEventListener("click", ()=>{ if(translationIndex>0) translationIndex--; updateComparePanel(currentSentence); });
  document.getElementById("next-translation").addEventListener("click", ()=>{ if(translationIndex < allEsSentences.length-1) translationIndex++; updateComparePanel(currentSentence); });
  document.getElementById("explain-jp").addEventListener("click", ()=>{
    const jp = extractPlainText(sentences[currentSentence]||{}); const query = `Explica el significado de la oraci√≥n en japon√©s "${jp}" en espa√±ol`; window.open(`https://chat.openai.com/?q=${encodeURIComponent(query)}`,"_blank");
  });

  document.addEventListener("keydown", e=>{
    if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA") return;
    if(e.key==="a"||e.key==="A"){ e.preventDefault(); prevSentence(); }
    if(e.key==="d"||e.key==="D"){ e.preventDefault(); nextSentence(); }
    if(e.key==="s"||e.key==="S"){ e.preventDefault(); repeatSentence(); }
    if(e.code==="Space"){ e.preventDefault(); playPause(); }
  });

  document.getElementById("playBtn").addEventListener("click", ()=>{ if(!sentences.length){ renderSpanishFromRaw(document.getElementById("text2").innerText||""); renderJapaneseFromRaw(document.getElementById("text1").innerText||""); } speakSentence(currentSentence||0); });
  document.getElementById("pauseBtn").addEventListener("click", ()=>{ if(synth.speaking && !isPaused){ try{ synth.pause(); }catch(e){} isPaused=true; } else if(isPaused){ try{ synth.resume(); }catch(e){} isPaused=false; } });
  document.getElementById("stopBtn").addEventListener("click", ()=>{ synth.cancel(); isPaused=false; });

  /* ========================
     Carga de archivos
     ======================== */
  async function handleFileInput(file,target){
    const text = await readFile(file);
    if(target==="jp"){
      await renderJapaneseFromRaw(text||"");
      allEsSentences = Array.from(document.getElementById("text2").querySelectorAll(".sentence-es"));
      translationIndex = 0; updateComparePanel(0);
    } else {
      renderSpanishFromRaw(text||"");
      sentences = Array.from(document.getElementById("text1").querySelectorAll(".sentence"));
      translationIndex = 0; updateComparePanel(0);
    }
  }
  document.getElementById("file1").addEventListener("change", e=>{ const f=e.target.files?.[0]; if(f) handleFileInput(f,"jp"); });
  document.getElementById("file2").addEventListener("change", e=>{ const f=e.target.files?.[0]; if(f) handleFileInput(f,"es"); });

  /* ========================
     Inicializaci√≥n
     ======================== */
  window.addEventListener("load", async ()=>{
    try{
      await initKuromoji();
    } catch(err){
      console.warn("Kuromoji inicializaci√≥n fallo (seguimos sin furigana):", err);
    }
    populateVoices();
    console.log("‚úÖ Lector Japon√©s - P√°gina lista. Carga archivos para probar.");
  });
  </script>
</body>
</html>
