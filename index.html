<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Lector Japon√©s - Comparativo y Voz</title>

  <!-- ============================================================
       Librer√≠as externas (CDN)
       - pdf.js (lectura PDF)
       - JSZip (soporte EPUB)
       - ePub.js (lectura EPUB)
       - kuromoji.js (tokenizaci√≥n japonesa + furigana)
       ============================================================ -->

  <!-- === PDF.js === -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
<script>
  if (window['pdfjsLib']) {
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js";
  }
</script>

<!-- === JSZip y ePub.js === -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.7.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

<!-- === Kuromoji.js (tokenizador japon√©s) === -->
<script id="kuromoji-script" src="https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dist/kuromoji.js"></script>
<script>
  // Esperar a que Kuromoji termine de cargar antes de cualquier uso
  window.kuromojiReady = new Promise((resolve, reject) => {
    const s = document.getElementById("kuromoji-script");
    s.addEventListener("load", () => {
      if (window.kuromoji && typeof window.kuromoji.builder === "function") {
        console.log("‚úÖ Kuromoji.js cargado y listo.");
        resolve(window.kuromoji);
      } else {
        reject(new Error("El objeto kuromoji no est√° disponible correctamente."));
      }
    });
    s.addEventListener("error", () => {
      reject(new Error("‚ùå No se pudo cargar kuromoji.js"));
    });
  });

  // Funci√≥n que espera la carga (sin bucle ni timeout)
  async function waitForKuromoji() {
    const lib = await window.kuromojiReady;
    return lib;
  }
</script>

  <style>
    /* --------------- Variables y reset --------------- */
    :root{
      --bg: #fbfbfd;
      --panel: #ffffff;
      --muted: #6b7280;
      --accent: #6c8cff;
      --accent-2: #ffd08a;
      --border: #e6e9ef;
      --glass: rgba(255,255,255,0.7);
    }

    * { box-sizing: border-box; }
    html,body { height: 100%; }
    body {
      margin: 0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Helvetica Neue", Arial;
      background: linear-gradient(180deg, #f6f8ff 0%, var(--bg) 100%);
      color: #111827;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* --------------- Top bar --------------- */
    #top-bar {
      display:flex;
      gap: 1.5rem;
      align-items: center;
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--panel);
      position: sticky;
      top: 0;
      z-index: 999;
      box-shadow: 0 1px 6px rgba(12,20,60,0.04);
    }
    #top-bar label { font-weight: 600; color: #0f172a; margin-right: 8px; }
    #top-bar input[type=file] { font-size: 0.95rem; }

    h1.page-title {
      margin: 12px 20px 8px;
      font-size: 1.18rem;
      font-weight: 700;
      color: #0b1220;
    }

    /* --------------- Main container --------------- */
    #container {
      display: flex;
      gap: 12px;
      padding: 18px;
      height: calc(100vh - 25vh - 120px);
    }

    #text1, #text2 {
      width: 50%;
      padding: 18px;
      overflow-y: auto;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      line-height: 1.9;
      font-size: 1.05rem;
      box-shadow: 0 8px 22px rgba(14,20,40,0.03);
      min-height: 120px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    #text2 { margin-left: 0; }

    /* Furigana style */
    ruby rt { font-size: 0.65em; color: #374151; font-weight: 600; }

    /* Sentence highlighting */
    .sentence { display: inline; padding: 2px 6px; border-radius: 6px; cursor: text; }
    .sentence.active-sentence { background: rgba(108,140,255,0.12); }
    .sentence-es { display: inline; padding: 2px 6px; border-radius: 6px; }
    .sentence-es.active-sentence-es { background: rgba(102,204,255,0.12); }

    /* --------------- Bottom bar --------------- */
    #bottom-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 25vh;
      display: flex;
      gap: 12px;
      border-top: 1px solid var(--border);
      background: rgba(255,255,255,0.96);
      z-index: 1000;
      padding: 12px;
      align-items: center;
    }

    #voice-panel {
      width: 18%;
      min-width: 190px;
      border-right: 1px solid var(--border);
      padding-right: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    #voice-panel select, #voice-panel input[type=range] { width: 100%; }

    #compare-panel { flex: 1; display:flex; flex-direction:column; gap:8px; align-items:center; }

    #jp-sentence { width: 95%; text-align:center; font-size:1.08rem; font-weight:600; color:#07103a; }
    #es-sentence { width:95%; text-align:center; font-size:0.98rem; color:var(--muted); min-height:2.4em; }

    #nav-buttons { display:flex; gap:8px; align-items:center; justify-content:flex-end; width:95%; }

    button.icon {
      background: linear-gradient(180deg, #fff, #f6f9ff);
      border: 1px solid var(--border);
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(12,20,60,0.03);
    }

    /* tooltip styles */
    .lexword { position: relative; padding: 0 2px; border-radius: 4px; }
    .lexword:hover { background: rgba(255,208,138,0.14); }
    .tooltip {
      position: absolute;
      bottom: 130%;
      left: 50%;
      transform: translateX(-50%);
      background: #0b1220;
      color: #fff;
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 0.85rem;
      box-shadow: 0 6px 18px rgba(2,6,23,0.3);
      white-space: nowrap;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.12s ease, transform 0.12s ease;
    }
    .lexword.show-tooltip .tooltip { opacity: 1; transform: translateX(-50%) translateY(-4px); pointer-events: auto; }

    /* responsive */
    @media (max-width: 900px) {
      #container { flex-direction: column; height: calc(50vh - 72px); }
      #text2 { margin-top: 10px; width: 100%; }
      #text1 { width: 100%; }
      #voice-panel { width: 30%; min-width: 140px; }
    }

    /* small helper logs area (hidden by default - can show for debugging) */
    #debug {
      position: fixed;
      top: 12px;
      right: 12px;
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 8px 10px;
      border-radius: 6px;
      font-size: 12px;
      z-index: 2000;
      display: none;
    }
  </style>
</head>
<body>

  <!-- ============================================================
       T√≠tulo y barra superior
       ============================================================ -->
  <h1 class="page-title">Lector Japon√©s - Comparativo y Voz</h1>

  <div id="top-bar">
    <div>
      <label for="file1">üìò Texto japon√©s:</label>
      <input type="file" id="file1" accept=".txt,.pdf,.epub" />
    </div>
    <div>
      <label for="file2">üìô Texto espa√±ol:</label>
      <input type="file" id="file2" accept=".txt,.pdf,.epub" />
    </div>
    <div style="margin-left:auto; color:var(--muted); font-size:0.95rem;">
      Tips: selecciona una voz japonesa y usa A/D/S/Espacio para navegar.
    </div>
  </div>

  <!-- ============================================================
       √Årea principal con paneles de texto
       ============================================================ -->
  <div id="container">
    <div id="text1">Cargar texto japon√©s aqu√≠‚Ä¶</div>
    <div id="text2">Cargar texto espa√±ol aqu√≠‚Ä¶</div>
  </div>

  <!-- ============================================================
       Barra inferior: voz + comparativo + navegaci√≥n
       ============================================================ -->
  <div id="bottom-bar">
    <div id="voice-panel">
      <label for="voiceSelect" style="font-size:0.95rem; font-weight:700;">Voz:</label>
      <select id="voiceSelect"></select>

      <label for="speedRange" style="font-size:0.95rem; font-weight:700; margin-top:6px;">Velocidad:</label>
      <input type="range" id="speedRange" min="0.5" max="2" value="1" step="0.1">

      <div style="display:flex; gap:8px; margin-top:8px;">
        <button id="playBtn" class="icon">‚ñ∂Ô∏é</button>
        <button id="pauseBtn" class="icon">‚è∏Ô∏é</button>
        <button id="stopBtn" class="icon">‚ñ†</button>
      </div>
      <div style="font-size:0.85rem; color:var(--muted); margin-top:6px;">
        Velocidad ajustable para TTS
      </div>
    </div>

    <div id="compare-panel">
      <div id="jp-sentence">ÔºàOraci√≥n japonesa aparecer√° aqu√≠Ôºâ</div>
      <div id="es-sentence">ÔºàTraducci√≥n en espa√±ol aparecer√° aqu√≠Ôºâ</div>
      <div id="nav-buttons">
        <button id="prev-translation" class="icon" title="Anterior">‚óÄ</button>
        <button id="next-translation" class="icon" title="Siguiente">‚ñ∂</button>
        <button id="explain-jp" class="icon" title="Explicar oraci√≥n">üí¨</button>
      </div>
    </div>
  </div>

  <div id="debug">debug</div>

  <!-- ============================================================
       SCRIPT: toda la l√≥gica (comentada y extendida)
       ============================================================ -->
  <script>
  /* ============================================================
     MINI DICCIONARIO (offline) ‚Äî exti√©ndelo si quieres
     key: lemma (forma b√°sica) -> value: traducci√≥n
     ============================================================ */
  const miniDict = {
    "ÁßÅ": "yo",
    "ÁßÅ„Åü„Å°": "nosotros",
    "Ë°å„Åè": "ir",
    "Ë°å„Åç„Åæ„Åô": "ir (formal)",
    "Ë°å„Å£„Åü": "ir (pasado)",
    "Ë¶ã„Çã": "ver",
    "È£ü„Åπ„Çã": "comer",
    "Â§ß„Åç„ÅÑ": "grande",
    "Â∞è„Åï„ÅÑ": "peque√±o",
    "Áå´": "gato",
    "Áä¨": "perro",
    "ÈÄü„ÅÑ": "r√°pido",
    "ÈÅÖ„ÅÑ": "lento",
    "Êñ∞„Åó„ÅÑ": "nuevo",
    "Âè§„ÅÑ": "viejo",
    "Êú¨": "libro",
    "Â≠¶Ê†°": "escuela",
    "ÂÖàÁîü": "profesor",
    "Â≠¶Áîü": "estudiante",
    "Â•Ω„Åç": "gustar",
    "È´ò„ÅÑ": "caro / alto",
    "ÂÆâ„ÅÑ": "barato",
    "Êù•„Çã": "venir",
    "Ë®Ä„ÅÜ": "decir"
  };

  /* ============================================================
     ESTADO GLOBAL
     ============================================================ */
  let kuromojiTokenizer = null;
  let sentences = [];         // spans .sentence en #text1
  let allEsSentences = [];    // spans .sentence-es en #text2
  let currentSentence = 0;
  let translationIndex = 0;
  let isPaused = false;
  const synth = window.speechSynthesis;
  let voices = [];

  const voiceSelect = document.getElementById("voiceSelect");
  const rateInput = document.getElementById("speedRange");

  /* ============================================================
     INICIALIZAR KUROMIJI (con logging y reintento si falla)
     - usa dicPath apuntando a CDN (funciona en GitHub Pages)
     ============================================================ */
 async function initKuromoji(retries = 2) {
  console.log("‚è≥ Esperando carga de Kuromoji...");
let lib;
try {
  lib = await waitForKuromoji();
} catch (e) {
  console.error("‚ùå Kuromoji no se carg√≥ correctamente:", e);
  throw e;
}

  return new Promise((resolve, reject) => {
    if (kuromojiTokenizer) return resolve(kuromojiTokenizer);

    console.log("üì¶ Inicializando tokenizador Kuromoji...");
    kuromoji.builder({
      dicPath: "https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict/"
    }).build((err, tokenizer) => {
      if (err) {
        console.warn("‚ö†Ô∏è Error al construir el tokenizador:", err);
        if (retries > 0) {
          console.log(`üîÅ Reintentando (${retries} restantes)...`);
          setTimeout(() => {
            initKuromoji(retries - 1).then(resolve).catch(reject);
          }, 1000);
        } else reject(err);
      } else {
        kuromojiTokenizer = tokenizer;
        console.log("‚úÖ Kuromoji inicializado correctamente.");
        resolve(tokenizer);
      }
    });
  });
}


  /* ============================================================
     UTILIDADES
     ============================================================ */
  function containsKanji(str) {
    return /[‰∏Ä-ÈæØ]/.test(str);
  }

  function kanaKatakanaToHiragana(str) {
    return str.replace(/[\u30a1-\u30f6]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0x60));
  }

  function escapeHtml(s) {
    return ("" + s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  function escapeAttr(s) {
    return ("" + s).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
  }

  /* ============================================================
     LECTURA DE ARCHIVOS: txt / pdf / epub
     - readFile(file) devuelve string
     ============================================================ */
  async function readFile(file) {
    const ext = (file.name || "").split('.').pop().toLowerCase();
    if (ext === "txt") {
      return await file.text();
    } else if (ext === "pdf") {
      try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let text = "";
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          text += content.items.map(it => it.str).join(' ') + "\n";
        }
        return text;
      } catch (e) {
        console.error("Error leyendo PDF:", e);
        return "";
      }
    } else if (ext === "epub") {
      try {
        const book = ePub(await file.arrayBuffer());
        const spine = await book.loaded.spine;
        let text = "";
        for (const item of spine) {
          try {
            const content = await book.load(item.href);
            text += new TextDecoder("utf-8").decode(content);
          } catch (err) {
            console.warn("Error leyendo item EPUB:", err);
          }
        }
        return text.replace(/<[^>]+>/g, ' ');
      } catch (e) {
        console.error("Error leyendo EPUB:", e);
        return "";
      }
    } else {
      alert("Formato no soportado: " + ext);
      return "";
    }
  }

  /* ============================================================
     SEGMENTACI√ìN + FURIGANA
     - processJapaneseRaw(raw) => array de strings (HTML con ruby)
     - evita lookbehind; usa split + reduce para mantener signos
     ============================================================ */
  async function processJapaneseRaw(raw) {
    // intenta inicializar kuromoji si es necesario
    try {
      await initKuromoji();
    } catch (err) {
      console.warn("Kuromoji no disponible, continuar√° sin furigana:", err);
    }

    raw = (raw || "").replace(/\r/g, "\n").trim();

    // split compatible: capturamos grupos de signos y saltos, luego reconstruimos
    const parts = raw.split(/([„ÄÇÔºÅÔºü?!\n]+)/u)
      .reduce((acc, cur) => {
        if (/^[„ÄÇÔºÅÔºü?!\n]+$/.test(cur)) {
          if (acc.length === 0) acc.push(cur);
          else acc[acc.length - 1] += cur;
        } else {
          acc.push(cur);
        }
        return acc;
      }, [])
      .map(p => p.trim())
      .filter(Boolean);

    const processedParts = [];

    for (const part of parts) {
      if (!kuromojiTokenizer) {
        // sin kuromoji: escapamos y devolvemos texto plano
        processedParts.push(escapeHtml(part));
        continue;
      }

      const tokens = kuromojiTokenizer.tokenize(part);
      const htmlPieces = tokens.map(t => {
        const surface = t.surface_form || "";
        const reading = t.reading || "";
        const basic = t.basic_form || surface;
        const pos = t.pos || "";

        // construir display: con ruby si contiene kanji y tiene reading
        let display = escapeHtml(surface);
        if (containsKanji(surface) && reading) {
          const hira = kanaKatakanaToHiragana(reading);
          display = `<ruby>${escapeHtml(surface)}<rt>${escapeHtml(hira)}</rt></ruby>`;
        }

        // marcar palabras l√©xicas para tooltip
        const isMajorPos = (pos === "ÂêçË©û" || pos === "ÂãïË©û" || pos === "ÂΩ¢ÂÆπË©û");
        if (isMajorPos) {
          const lookupKey = escapeAttr(basic === "*" ? surface : basic);
          const posAttr = escapeAttr(pos);
          return `<span class="lexword" data-lemma="${lookupKey}" data-pos="${posAttr}">${display}<span class="tooltip"></span></span>`;
        } else {
          return display;
        }
      });

      processedParts.push(htmlPieces.join(""));
    }

    return processedParts;
  }

  /* ============================================================
     RENDERIZADO: insertar HTML en #text1 y #text2
     ============================================================ */
  async function renderJapaneseFromRaw(raw) {
    const container = document.getElementById("text1");
    const processed = await processJapaneseRaw(raw);
    container.innerHTML = processed.map((p, i) => `<span class="sentence" data-index="${i}">${p}</span>`).join(" ");
    sentences = Array.from(container.querySelectorAll(".sentence"));
    attachTooltipEvents();
  }

  function renderSpanishFromRaw(raw) {
    const container = document.getElementById("text2");
    const parts = raw.split(/([„ÄÇ.!?ÔºÅÔºü\n]+)/u)
      .reduce((acc, cur) => {
        if (/^[„ÄÇ.!?ÔºÅÔºü\n]+$/.test(cur)) {
          if (acc.length === 0) acc.push(cur);
          else acc[acc.length - 1] += cur;
        } else {
          acc.push(cur);
        }
        return acc;
      }, [])
      .map(p => p.trim())
      .filter(Boolean);

    container.innerHTML = parts.map((p, i) => `<span class="sentence-es" data-index="${i}">${escapeHtml(p)}</span>`).join(" ");
    allEsSentences = Array.from(container.querySelectorAll(".sentence-es"));
  }

  /* ============================================================
     TOOLTIP: eventos para .lexword (mouseenter, mouseleave, click)
     ============================================================ */
  function attachTooltipEvents() {
    document.querySelectorAll(".lexword").forEach(node => {
      // eliminar handlers previos por seguridad
      node.onmouseenter = null; node.onmouseleave = null; node.onclick = null;

      node.addEventListener("mouseenter", onLexEnter);
      node.addEventListener("mouseleave", onLexLeave);
      node.addEventListener("click", onLexClick);
    });
  }

  function onLexEnter(e) {
    showTooltipFor(e.currentTarget);
  }
  function onLexLeave(e) {
    hideTooltipFor(e.currentTarget);
  }
  function onLexClick(e) {
    const node = e.currentTarget;
    showTooltipFor(node);
    setTimeout(() => hideTooltipFor(node), 2500);
  }

  function showTooltipFor(node) {
    const lemma = node.dataset.lemma || node.textContent.trim();
    let text = miniDict[lemma] || miniDict[node.textContent.trim()] || null;
    if (!text) {
      const rt = node.querySelector("rt");
      if (rt) text = `Lectura: ${rt.textContent}`;
      else text = "sin traducci√≥n (diccionario offline limitado)";
    }
    const tooltip = node.querySelector(".tooltip");
    if (tooltip) {
      tooltip.textContent = text;
      node.classList.add("show-tooltip");
    }
  }

  function hideTooltipFor(node) {
    const tooltip = node.querySelector(".tooltip");
    if (tooltip) tooltip.textContent = "";
    node.classList.remove("show-tooltip");
  }

  /* ============================================================
     TTS: Web Speech API (llenado de voices, manejo reproducci√≥n)
     ============================================================ */
  function populateVoices() {
    voices = synth.getVoices().filter(v => v.lang && v.lang.startsWith("ja"));
    // fallback: si no hay voces japonesas, usar todas (user may not have ja voices)
    if (!voices.length) voices = synth.getVoices() || [];

    voiceSelect.innerHTML = "";
    voices.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v.name;
      opt.textContent = `${v.name} (${v.lang})`;
      voiceSelect.appendChild(opt);
    });
  }
  populateVoices();
  speechSynthesis.onvoiceschanged = populateVoices;

  function extractPlainText(element) {
    const clone = element.cloneNode(true);
    clone.querySelectorAll("rt, .tooltip").forEach(n => n.remove());
    return clone.innerText.trim();
  }

  function speakSentence(index) {
    if (!sentences.length) return;
    if (!voices.length) populateVoices();
    const sentenceElement = sentences[index];
    if (!sentenceElement) return;
    const sentence = extractPlainText(sentenceElement);
    synth.cancel();

    const utterance = new SpeechSynthesisUtterance(sentence);
    utterance.voice = voices.find(v => v.name === voiceSelect.value) || voices[0];
    utterance.rate = parseFloat(rateInput.value) || 1;
    utterance.lang = "ja-JP";

    highlightSentence(index);

    utterance.onend = () => {
      if (!isPaused && index < sentences.length - 1) {
        currentSentence++;
        speakSentence(currentSentence);
      }
    };

    synth.speak(utterance);
  }

  /* ============================================================
     Resaltado y panel comparativo
     ============================================================ */
  function highlightSentence(index) {
    sentences.forEach(s => s.classList.remove("active-sentence"));
    allEsSentences.forEach(s => s.classList.remove("active-sentence-es"));

    if (sentences[index]) {
      sentences[index].classList.add("active-sentence");
      sentences[index].scrollIntoView({ behavior: "smooth", block: "center" });
    }

    if (allEsSentences[translationIndex]) {
      allEsSentences[translationIndex].classList.add("active-sentence-es");
      allEsSentences[translationIndex].scrollIntoView({ behavior: "smooth", block: "center" });
    }

    updateComparePanel(index);
  }

  function updateComparePanel(index) {
    const jpSentenceEl = sentences[index];
    const esSentenceEl = allEsSentences[translationIndex];
    document.getElementById("jp-sentence").innerHTML = jpSentenceEl ? jpSentenceEl.innerHTML : "ÔºàOraci√≥n japonesa aparecer√° aqu√≠Ôºâ";
    document.getElementById("es-sentence").textContent = esSentenceEl ? esSentenceEl.innerText : "ÔºàTraducci√≥n en espa√±ol aparecer√° aqu√≠Ôºâ";
  }

  /* ============================================================
     Controles: play / pause / next / prev / repeat
     ============================================================ */
  function playPause() {
    if (synth.speaking && !isPaused) {
      try { synth.pause(); } catch(e) {}
      isPaused = true;
    } else if (isPaused) {
      try { synth.resume(); } catch(e) {}
      isPaused = false;
    } else {
      if (!sentences.length) {
        // construir arrays si a√∫n no procesados
        renderSpanishFromRaw(document.getElementById("text2").innerText || "");
        renderJapaneseFromRaw(document.getElementById("text1").innerText || "");
      }
      currentSentence = 0;
      isPaused = false;
      speakSentence(currentSentence);
    }
  }

  function nextSentence() {
    if (currentSentence < sentences.length - 1) {
      currentSentence++;
      synth.cancel();
      speakSentence(currentSentence);
    }
  }
  function prevSentence() {
    if (currentSentence > 0) {
      currentSentence--;
      synth.cancel();
      speakSentence(currentSentence);
    }
  }
  function repeatSentence() {
    synth.cancel();
    speakSentence(currentSentence);
  }

  /* ============================================================
     Eventos de interacci√≥n
     ============================================================ */
  // click on japanese text sentence
  document.getElementById("text1").addEventListener("click", e => {
    const clicked = e.target.closest(".sentence");
    if (!clicked) return;
    const index = sentences.indexOf(clicked);
    if (index !== -1) {
      currentSentence = index;
      highlightSentence(index);
      speakSentence(index);
    }
  });

  // navigation / explain buttons
  document.getElementById("prev-translation").addEventListener("click", () => {
    if (translationIndex > 0) translationIndex--;
    updateComparePanel(currentSentence);
  });
  document.getElementById("next-translation").addEventListener("click", () => {
    if (translationIndex < allEsSentences.length - 1) translationIndex++;
    updateComparePanel(currentSentence);
  });
  document.getElementById("explain-jp").addEventListener("click", () => {
    const jpSentence = extractPlainText(sentences[currentSentence] || {});
    const query = `Explica el significado de la oraci√≥n en japon√©s "${jpSentence}" en espa√±ol`;
    const chatUrl = `https://chat.openai.com/?q=${encodeURIComponent(query)}`;
    window.open(chatUrl, "_blank");
  });

  // keyboard controls
  document.addEventListener("keydown", e => {
    if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA") return;
    if (e.key === "a" || e.key === "A") { e.preventDefault(); prevSentence(); }
    if (e.key === "d" || e.key === "D") { e.preventDefault(); nextSentence(); }
    if (e.key === "s" || e.key === "S") { e.preventDefault(); repeatSentence(); }
    if (e.code === "Space") { e.preventDefault(); playPause(); }
  });

  // bottom buttons
  document.getElementById("playBtn").addEventListener("click", () => {
    if (!sentences.length) { renderSpanishFromRaw(document.getElementById("text2").innerText || ""); renderJapaneseFromRaw(document.getElementById("text1").innerText || ""); }
    speakSentence(currentSentence || 0);
  });
  document.getElementById("pauseBtn").addEventListener("click", () => {
    if (synth.speaking && !isPaused) { try { synth.pause(); } catch(e) {} isPaused = true; }
    else if (isPaused) { try { synth.resume(); } catch(e) {} isPaused = false; }
  });
  document.getElementById("stopBtn").addEventListener("click", () => { synth.cancel(); isPaused = false; });

  /* ============================================================
     Carga de archivos (inputs)
     - handleFileInput(file, "jp"|"es")
     ============================================================ */
  async function handleFileInput(file, targetLang) {
    const text = await readFile(file);
    if (targetLang === "jp") {
      await renderJapaneseFromRaw(text || "");
      allEsSentences = Array.from(document.getElementById("text2").querySelectorAll(".sentence-es"));
      translationIndex = 0;
      updateComparePanel(0);
    } else {
      renderSpanishFromRaw(text || "");
      sentences = Array.from(document.getElementById("text1").querySelectorAll(".sentence"));
      translationIndex = 0;
      updateComparePanel(0);
    }
  }

  document.getElementById("file1").addEventListener("change", e => {
    const file = e.target.files?.[0];
    if (file) handleFileInput(file, "jp");
  });
  document.getElementById("file2").addEventListener("change", e => {
    const file = e.target.files?.[0];
    if (file) handleFileInput(file, "es");
  });

  /* ============================================================
     Inicializaci√≥n al cargar la p√°gina
     ============================================================ */
  window.addEventListener("load", async () => {
    try {
      await initKuromoji();
    } catch (err) {
      console.warn("Kuromoji inicializaci√≥n fallo (seguimos sin furigana):", err);
    }
    populateVoices();
    // debug: mostrar caja si quieres ver logs
    // document.getElementById("debug").style.display = "block";
    console.log("‚úÖ Lector Japon√©s - P√°gina lista. Carga archivos para probar.");
  });

  /* ============================================================
     FIN
     ============================================================ */
  </script>

</body>
</html>
