<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Lector Japon√©s - Comparativo, Furigana y Jisho Tooltips</title>

  <!-- ============================
       Dependencias y configuraci√≥n
       - PDF.js worker (CDN)
       - JSZip / ePub.js (CDN)
       - kuromoji.js (LOCAL: js/kuromoji.js)
       ============================ -->

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
  <script>
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js";
    }
  </script>

  <!-- JSZip / ePub.js -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.7.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>

  <!-- kuromoji.js local - coloca js/kuromoji.js en tu repo -->
  <script id="kuromoji-script" src="js/kuromoji.js"></script>
  <script>
    // Promesa que se resuelve cuando kuromoji ha cargado y definido window.kuromoji
    window.kuromojiReady = new Promise((resolve, reject) => {
      const s = document.getElementById("kuromoji-script");
      // Si ya est√° definido
      if (window.kuromoji && typeof window.kuromoji.builder === "function") {
        console.log("‚úÖ kuromoji.js ya disponible");
        resolve(window.kuromoji);
        return;
      }
      // Listeners
      s.addEventListener("load", () => {
        if (window.kuromoji && typeof window.kuromoji.builder === "function") {
          console.log("‚úÖ kuromoji.js cargado correctamente");
          resolve(window.kuromoji);
        } else {
          reject(new Error("kuromoji se carg√≥ pero window.kuromoji no est√° disponible"));
        }
      });
      s.addEventListener("error", () => {
        reject(new Error("No se pudo cargar js/kuromoji.js (revisa ruta js/kuromoji.js)"));
      });
      // Small fallback: check shortly after
      setTimeout(() => {
        if (window.kuromoji && typeof window.kuromoji.builder === "function") {
          resolve(window.kuromoji);
        }
      }, 100);
    });

    async function waitForKuromoji() {
      return await window.kuromojiReady;
    }
  </script>

  <!-- ============================
       <!-- ============================
     üé® Estilos (moderno y coherente)
     ============================ -->
<style>
:root {
  --bg: #f9f6ef;        /* fondo crema */
  --panel: #fffdf8;     /* panel blanco c√°lido */
  --text: #2a2a2a;      /* texto principal */
  --muted: #6b6b6b;     /* texto secundario */
  --accent: #a67c52;    /* marr√≥n dorado */
  --border: #e4dfd3;    /* borde suave */
}

/* üåô Modo oscuro */
[data-theme="dark"] {
  --bg: #121212;
  --panel: #1e1e1e;
  --text: #f3f3f3;
  --muted: #b0b0b0;
  --accent: #d4af7a;
  --border: #2a2a2a;
}

* {
  box-sizing: border-box;
  transition: background-color 0.25s ease, color 0.25s ease, border-color 0.25s ease;
}

html, body {
  height: 100%;
  margin: 0;
  font-family: 'Inter', 'Noto Sans JP', system-ui, sans-serif;
  color: var(--text);
  background: var(--bg);
  transition: background-color 0.4s ease, color 0.4s ease;
}

/* --------- BOTONES SUPERIORES --------- */
#top-buttons {
  position: fixed;
  top: 16px;
  right: 16px;
  display: flex;
  gap: 16px;
  z-index: 100;
}

#top-buttons button {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 50%;
  width: 42px;
  height: 42px;
  font-size: 1.2rem;
  cursor: pointer;
  color: var(--text);
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.25s ease, background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
}
#top-buttons button:hover {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
  transform: scale(1.07);
}

/* --------- ENCABEZADO --------- */
h1.page-title {
  margin: 14px 20px;
  font-size: 1.2rem;
  font-weight: 700;
}

#top-bar {
  display: flex;
  gap: 1rem;
  align-items: center;
  padding: 14px 20px;
  border-bottom: 1px solid var(--border);
  background: var(--panel);
  position: sticky;
  top: 0;
  z-index: 60;
  border-radius: 0 0 20px 20px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
}

/* --------- CONTENIDO PRINCIPAL --------- */
#container {
  display: flex;
  gap: 18px;
  padding: 18px;
  height: calc(100vh - 25vh - 120px);
}

#text1, #text2 {
  width: 50%;
  padding: 20px;
  overflow-y: auto;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 24px;
  line-height: 1.9;
  font-size: 1.05rem;
  min-height: 120px;
  white-space: pre-wrap;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
}

/* --------- ORACIONES --------- */
ruby rt {
  font-size: .65em;
  color: var(--muted);
  font-weight: 600;
}

.sentence {
  display: inline;
  padding: 3px 8px;
  border-radius: 10px;
  cursor: text;
}
.sentence.active-sentence {
  background: rgba(108, 140, 255, 0.14);
}
.sentence-es {
  display: inline;
  padding: 3px 8px;
  border-radius: 10px;
}
.sentence-es.active-sentence-es {
  background: rgba(102, 204, 255, 0.12);
}

/* --------- PANEL INFERIOR --------- */
#bottom-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 25vh;
  display: flex;
  gap: 12px;
  border-top: 1px solid var(--border);
  background: var(--panel);
  z-index: 70;
  padding: 12px;
  align-items: center;
  border-radius: 20px 20px 0 0;
  box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.05);
}

#voice-panel {
  width: 18%;
  min-width: 180px;
  border-right: 1px solid var(--border);
  padding-right: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

#compare-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 8px;
  align-items: center;
}

#jp-sentence {
  width: 95%;
  text-align: center;
  font-size: 1.08rem;
  font-weight: 600;
  color: var(--text);
}
#es-sentence {
  width: 95%;
  text-align: center;
  font-size: .98rem;
  color: var(--muted);
  min-height: 2.4em;
}

/* --------- BOTONES GENERALES --------- */
.icon {
  background: var(--panel);
  border: 1px solid var(--border);
  padding: 8px 12px;
  border-radius: 12px;
  cursor: pointer;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
  transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
}
.icon:hover {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}

/* --------- TOOLTIP --------- */
.lexword {
  position: relative;
  padding: 0 2px;
  border-radius: 6px;
}
.lexword:hover {
  background: rgba(255, 208, 138, 0.14);
}
.tooltip {
  position: absolute;
  bottom: 130%;
  left: 50%;
  transform: translateX(-50%);
  background: #0b1220;
  color: #fff;
  padding: 8px 10px;
  border-radius: 8px;
  font-size: .9rem;
  box-shadow: 0 6px 18px rgba(2, 6, 23, .3);
  white-space: nowrap;
  z-index: 9999;
  opacity: 0;
  pointer-events: none;
  transition: opacity .12s, transform .12s;
}
.lexword.show-tooltip .tooltip {
  opacity: 1;
  transform: translateX(-50%) translateY(-4px);
  pointer-events: auto;
}
.tooltip .title {
  font-weight: 700;
  margin-bottom: 4px;
}
.tooltip .small {
  font-size: .8rem;
  color: #e6e6e6;
  margin-top: 6px;
}

/* --------- BOT√ìN MODO OSCURO --------- */
#theme-toggle {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  background: var(--panel);
  border: 1px solid var(--border);
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
  transition: transform 0.25s ease;
}
#theme-toggle:hover {
  transform: rotate(20deg) scale(1.08);
}

/* --------- RESPONSIVE --------- */
@media (max-width: 900px) {
  #container {
    flex-direction: column;
    height: calc(50vh - 72px);
  }
  #text1, #text2 {
    width: 100%;
  }
  #voice-panel {
    width: 30%;
  }
}
</style>

</head>
<body>
  <h1 class="page-title">Lector Japon√©s - Comparativo y Voz (Jisho tooltips)</h1>

  <div id="top-bar">
    <div><label for="file1">üìò Texto japon√©s:</label><input id="file1" type="file" accept=".txt,.pdf,.epub"></div>
    <div><label for="file2">üìô Texto espa√±ol:</label><input id="file2" type="file" accept=".txt,.pdf,.epub"></div>
    <div style="margin-left:auto;color:var(--muted);font-size:.95rem">Tips: selecciona voz y usa A/D/S/Espacio</div>
  </div>

  <div id="container">
    <div id="text1">Cargar texto japon√©s aqu√≠‚Ä¶</div>
    <div id="text2">Cargar texto espa√±ol aqu√≠‚Ä¶</div>
  </div>

  <div id="bottom-bar">
    <div id="voice-panel">
      <label for="voiceSelect" style="font-weight:700">Voz:</label>
      <select id="voiceSelect"></select>
      <label for="speedRange" style="margin-top:6px;font-weight:700">Velocidad:</label>
      <input id="speedRange" type="range" min="0.5" max="2" step="0.1" value="1">
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="playBtn" class="icon">‚ñ∂Ô∏é</button>
        <button id="pauseBtn" class="icon">‚è∏Ô∏é</button>
        <button id="stopBtn" class="icon">‚ñ†</button>
      </div>
      <div style="font-size:.85rem;color:var(--muted);margin-top:6px">Ajusta la velocidad para TTS</div>
    </div>

    <div id="compare-panel">
      <div id="jp-sentence">ÔºàOraci√≥n japonesa aparecer√° aqu√≠Ôºâ</div>
      <div id="es-sentence">ÔºàTraducci√≥n en espa√±ol aparecer√° aqu√≠Ôºâ</div>
      <div id="nav-buttons" style="width:95%;display:flex;justify-content:flex-end;gap:8px">
        <button id="prev-translation" class="icon" title="Anterior">‚óÄ</button>
        <button id="next-translation" class="icon" title="Siguiente">‚ñ∂</button>
        <button id="explain-jp" class="icon" title="Explicar oraci√≥n">üí¨</button>
      </div>
    </div>
  </div>

  <!-- ============================
       SCRIPT PRINCIPAL
       - Kuromoji local (./dict/)
       - Tooltips: Jisho.org API (online)
       - Cache en localStorage
       ============================ -->
  <script>
    /* ======================
   VARIABLES GLOBALES
   ====================== */
let consultedWords = [];       // palabras consultadas con el mouse
let consultedExpressions = []; // expresiones analizadas con ChatGPT
  /* ---------------------------
     Mini-diccionario offline fallback (no obligatorio)
     --------------------------- */
  const miniDict = {
    "ÁßÅ": "yo", "Áå´": "gato", "Ë°å„Åè": "ir", "È£ü„Åπ„Çã": "comer", "Â≠¶Áîü": "estudiante"
  };

  /* ---------------------------
     Estado global
     --------------------------- */
  let kuromojiTokenizer = null;
  let sentences = [];
  let allEsSentences = [];
  let currentSentence = 0;
  let translationIndex = 0;
  let isPaused = false;

  const synth = window.speechSynthesis;
  let voices = [];
  const voiceSelect = document.getElementById("voiceSelect");
  const rateInput = document.getElementById("speedRange");

  /* ---------------------------
     Inicializar Kuromoji (dic local: ./dict/)
     --------------------------- */
  async function initKuromoji(retries = 2) {
    console.log("‚è≥ Esperando kuromoji...");
    try {
      await waitForKuromoji(); // promesa del head
    } catch (e) {
      console.error("‚ùå kuromoji.js no est√° disponible:", e);
      throw e;
    }

    return new Promise((resolve, reject) => {
      if (kuromojiTokenizer) return resolve(kuromojiTokenizer);
      try {
        kuromoji.builder({ dicPath: "./dict/" }).build((err, tokenizer) => {
          if (err) {
            console.warn("‚ö†Ô∏è Error al construir tokenizador:", err);
            if (retries > 0) {
              setTimeout(() => initKuromoji(retries - 1).then(resolve).catch(reject), 900);
            } else reject(err);
            return;
          }
          kuromojiTokenizer = tokenizer;
          console.log("‚úÖ Kuromoji inicializado (dic local).");
          resolve(tokenizer);
        });
      } catch (e) {
        reject(e);
      }
    });
  }

  /* ---------------------------
     Utilidades
     --------------------------- */
  function containsKanji(s){ return /[‰∏Ä-ÈæØ]/.test(s); }
  function kanaKatakanaToHiragana(str){ return str.replace(/[\u30a1-\u30f6]/g,ch=>String.fromCharCode(ch.charCodeAt(0)-0x60)); }
  function escapeHtml(s){ return (""+s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function escapeAttr(s){ return (""+s).replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

  /* ---------------------------
     LECTURA DE ARCHIVOS: txt / pdf / epub
--------------------------- */
async function readFile(file) {
  const ext = (file.name || "").split('.').pop().toLowerCase();

  // üìÑ TXT
  if (ext === "txt") {
    return await file.text();
  }

  // üìò PDF
  if (ext === "pdf") {
    try {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let text = "";
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        text += content.items.map(it => it.str).join(' ') + "\n";
      }
      return text;
    } catch (e) {
      console.error("Error leyendo PDF:", e);
      return "";
    }
  }

  // üìö EPUB
if (ext === "epub") {
  try {
    const book = ePub(await file.arrayBuffer());
    await book.ready; // Espera a que cargue todo

    const spineItems = book.spine?.spineItems || [];
    if (!spineItems.length) {
      console.warn("‚ö†Ô∏è EPUB sin spineItems v√°lidos.");
      return "";
    }

    let text = "";
    for (const item of spineItems) {
      try {
        // üìñ Cargar cada cap√≠tulo como texto plano
        const content = await item.load(book.load.bind(book));
        const html = await item.render(); // genera HTML de la secci√≥n
        const raw = html?.text || html || "";
        const clean = raw
          .replace(/<script[^>]*>.*?<\/script>/gi, "")
          .replace(/<style[^>]*>.*?<\/style>/gi, "")
          .replace(/<[^>]+>/g, " ")
          .replace(/\s+/g, " ")
          .trim();
        text += clean + "\n";
      } catch (err) {
        console.warn("Error leyendo secci√≥n EPUB:", err);
      }
    }

    return text;
  } catch (e) {
    console.error("Error EPUB:", e);
    return "";
  }
}

  alert("Formato no soportado: " + ext);
  return "";
}

  /* ---------------------------
     Segmentaci√≥n + Furigana con Kuromoji
     --------------------------- */
  async function processJapaneseRaw(raw){
    try { await initKuromoji(); } catch(err) { console.warn("Kuromoji no disponible, sin furigana:", err); }

    raw = (raw||"").replace(/\r/g,"\n").trim();

    // segment: keep punctuation
    const parts = raw.split(/([„ÄÇÔºÅÔºü?!\n]+)/u)
      .reduce((acc, cur) => { if (/^[„ÄÇÔºÅÔºü?!\n]+$/.test(cur)){ if (acc.length===0) acc.push(cur); else acc[acc.length-1]+=cur; } else acc.push(cur); return acc; }, [])
      .map(p=>p.trim()).filter(Boolean);

    const out = [];
    for (const part of parts){
      if (!kuromojiTokenizer) { out.push(escapeHtml(part)); continue; }
      const tokens = kuromojiTokenizer.tokenize(part);
      const html = tokens.map(t=>{
        const surface = t.surface_form || "";
        const reading = t.reading || "";
        const basic = t.basic_form || surface;
        const pos = t.pos || "";

        let display = escapeHtml(surface);
        if (containsKanji(surface) && reading) {
          const hira = kanaKatakanaToHiragana(reading);
          display = `<ruby>${escapeHtml(surface)}<rt>${escapeHtml(hira)}</rt></ruby>`;
        }

        const isLex = (pos==="ÂêçË©û"||pos==="ÂãïË©û"||pos==="ÂΩ¢ÂÆπË©û");
        if (isLex) {
          const lemma = escapeAttr(basic==="*" ? surface : basic);
          return `<span class="lexword" data-lemma="${lemma}" data-surface="${escapeAttr(surface)}">${display}<span class="tooltip"></span></span>`;
        }
        return display;
      }).join("");
      out.push(html);
    }
    return out;
  }

  /* ---------------------------
     Renderizado
     --------------------------- */
  async function renderJapaneseFromRaw(raw){
    const cont = document.getElementById("text1");
    const processed = await processJapaneseRaw(raw);
    cont.innerHTML = processed.map((p,i)=>`<span class="sentence" data-index="${i}">${p}</span>`).join(" ");
    sentences = Array.from(cont.querySelectorAll(".sentence"));
    attachTooltipEvents(); // vincula tooltips a nuevos lexwords
  }

  function renderSpanishFromRaw(raw){
    const cont = document.getElementById("text2");
    const parts = raw.split(/([„ÄÇ.!?ÔºÅÔºü\n]+)/u)
      .reduce((acc,cur)=>{ if(/^[„ÄÇ.!?ÔºÅÔºü\n]+$/.test(cur)){ if(acc.length===0) acc.push(cur); else acc[acc.length-1]+=cur; } else acc.push(cur); return acc; },[])
      .map(p=>p.trim()).filter(Boolean);
    cont.innerHTML = parts.map((p,i)=>`<span class="sentence-es" data-index="${i}">${escapeHtml(p)}</span>`).join(" ");
    allEsSentences = Array.from(cont.querySelectorAll(".sentence-es"));
  }

  /* ---------------------------
     Jisho API tooltip logic (online)
     - cache in localStorage (key: jisho_cache)
     - debounced requests to avoid bursts
     --------------------------- */
  const JISHO_CACHE_KEY = "jisho_cache_v1";
  const jishoCache = (function(){ try { return JSON.parse(localStorage.getItem(JISHO_CACHE_KEY)) || {}; } catch { return {}; } })();

  function saveJishoCache(){ try { localStorage.setItem(JISHO_CACHE_KEY, JSON.stringify(jishoCache)); } catch(e){} }

  // Debounce utility
  function debounce(fn, wait=250){
    let t;
    return function(...args){ clearTimeout(t); t = setTimeout(()=>fn.apply(this,args), wait); };
  }

  // Fetch from Jisho; returns null or an object {word,reading,meanings[]}
  async function fetchJisho(word){
    try {
      const q = encodeURIComponent(word);
      const url = `https://jisho.org/api/v1/search/words?keyword=${q}`;
      const r = await fetch(url);
      if (!r.ok) return null;
      const data = await r.json();
      if (!data || !data.data || data.data.length===0) return null;
      // take first result with senses
      const first = data.data[0];
      const wordEntry = {
        word: first.japanese && first.japanese[0] && first.japanese[0].word ? first.japanese[0].word : (first.japanese[0] && first.japanese[0].reading ? first.japanese[0].reading : word),
        reading: first.japanese && first.japanese[0] && first.japanese[0].reading ? first.japanese[0].reading : "",
        senses: (first.senses || []).map(s => s.english_definitions ? s.english_definitions.join("; ") : "").filter(Boolean)
      };
      return wordEntry;
    } catch (e) {
      console.warn("Jisho fetch error:", e);
      return null;
    }
  }

  // get translation: check cache first, then Jisho
  async function getTranslationFor(lemma){
    if (!lemma) return null;
    if (jishoCache[lemma]) return jishoCache[lemma];
    const res = await fetchJisho(lemma);
    if (res) {
      jishoCache[lemma] = res;
      saveJishoCache();
      return res;
    }
    return null;
  }

  /* ---------------------------
     Tooltip events: attach/detach
     --------------------------- */
  function attachTooltipEvents(){
    document.querySelectorAll(".lexword").forEach(node => {
      // prevent duplicate
      node.onmouseenter = null; node.onmouseleave = null; node.onclick = null;
      node.addEventListener("mouseenter", onLexEnter);
      node.addEventListener("mouseleave", onLexLeave);
      node.addEventListener("click", onLexClick);
    });
  }

  // Debounced wrapper to limit requests (per node)
  const _pending = new WeakMap();
  function onLexEnter(e) {
  const node = e.currentTarget;

  // üîπ Obtener texto base y forma de diccionario
  const surface = node.dataset.surface || node.textContent.trim();
  const lemma = node.dataset.lemma || surface;

  // üîπ Crear tooltip (mostrar mientras busca)
  const tooltip = node.querySelector(".tooltip");
  tooltip.innerHTML = `
    <div class="title">${escapeHtml(surface)}</div>
    <div>Buscando‚Ä¶</div>
  `;
  node.classList.add("show-tooltip");

  // üîπ Mostrar de inmediato si ya est√° en miniDic
  if (miniDict[lemma]) {
    tooltip.innerHTML = `
      <div class="title">${escapeHtml(surface)}</div>
      <div>${escapeHtml(miniDict[lemma])}</div>
      <div class="small">Fuente: miniDict</div>
    `;
    // Registrar palabra si no estaba
    if (!consultedWords.some(w => w.kanji === lemma)) {
      consultedWords.push({
        kanji: lemma,
        reading: node.dataset.reading || "",
        meaning: miniDict[lemma]
      });
    }
    return;
  }

  // üîπ Mostrar si ya est√° en cach√© (Jisho)
  if (jishoCache[lemma]) {
    const entry = jishoCache[lemma];
    tooltip.innerHTML = buildTooltipHtml(entry, surface);

    const reading = entry.reading ? kanaKatakanaToHiragana(entry.reading) : "";
    const meaning = entry.senses ? entry.senses.join("; ") : "";

    if (!consultedWords.some(w => w.kanji === lemma)) {
      consultedWords.push({ kanji: lemma, reading, meaning });
    }
    return;
  }

  // üîπ Si no est√° en cache, consultar a Jisho (con debounce)
  if (!_pending.has(node)) {
    const fn = debounce(async () => {
      try {
        const entry = await getTranslationFor(lemma);
        const tip = node.querySelector(".tooltip");

        if (entry) {
          tip.innerHTML = buildTooltipHtml(entry, surface);

          const reading = entry.reading
            ? kanaKatakanaToHiragana(entry.reading)
            : "";
          const meaning = entry.senses ? entry.senses.join("; ") : "";

          if (!consultedWords.some(w => w.kanji === lemma)) {
            consultedWords.push({ kanji: lemma, reading, meaning });
          }
        } else {
          const rt = node.querySelector("rt");
          const fallback = rt
            ? `Lectura: ${rt.textContent}`
            : "(sin resultados)";
          tip.innerHTML = `
            <div class="title">${escapeHtml(surface)}</div>
            <div>${escapeHtml(fallback)}</div>
            <div class="small">Fuente: Jisho.org</div>
          `;
        }
      } catch (err) {
        const tip = node.querySelector(".tooltip");
        tip.innerHTML = `
          <div class="title">${escapeHtml(surface)}</div>
          <div>(error al consultar)</div>
        `;
      }
    }, 120);
    _pending.set(node, fn);
  }

  // üîπ Ejecutar b√∫squeda
  _pending.get(node)();
}


  function buildTooltipHtml(entry, surface){
    // entry: {word, reading, senses: [...]}
    const title = escapeHtml(surface);
    const reading = entry.reading ? ` (${escapeHtml(entry.reading)})` : "";
    const defs = (entry.senses && entry.senses.length) ? entry.senses.slice(0,3).map(d=>escapeHtml(d)).join("<br>") : "(sin definiciones)";
    return `<div class="title">${title}${reading}</div><div>${defs}</div><div class="small">Fuente: Jisho.org</div>`;
  }

  function onLexLeave(e){
    const node = e.currentTarget;
    hideTooltipFor(node);
  }
  function onLexClick(e){
    const node = e.currentTarget;
    // keep for a short while
    showTooltipFor(node);
    setTimeout(()=>hideTooltipFor(node), 3000);
  }

  function showTooltipFor(node){
    const tip = node.querySelector(".tooltip");
    if (tip && tip.innerHTML.trim()==="") {
      const surface = node.dataset.surface || node.textContent.trim();
      const rt = node.querySelector("rt");
      tip.innerHTML = `<div class="title">${escapeHtml(surface)}</div><div>${rt ? "Lectura: "+escapeHtml(rt.textContent) : "(sin datos)"} </div>`;
    }
    node.classList.add("show-tooltip");
  }
  function hideTooltipFor(node){
    const tip = node.querySelector(".tooltip");
    if (tip) tip.innerHTML = "";
    node.classList.remove("show-tooltip");
  }

  /* ---------------------------
     TTS: Web Speech API
     --------------------------- */
  function populateVoices(){
    voices = synth.getVoices().filter(v=>v.lang && v.lang.startsWith("ja"));
    if (!voices.length) voices = synth.getVoices() || [];
    voiceSelect.innerHTML = "";
    voices.forEach(v=>{ const opt=document.createElement("option"); opt.value=v.name; opt.textContent=`${v.name} (${v.lang})`; voiceSelect.appendChild(opt); });
  }
  populateVoices();
  speechSynthesis.onvoiceschanged = populateVoices;

  function extractPlainText(el){
    const clone = el.cloneNode(true);
    clone.querySelectorAll("rt, .tooltip").forEach(n=>n.remove());
    return clone.innerText.trim();
  }

  function speakSentence(index){
    if (!sentences.length) return;
    if (!voices.length) populateVoices();
    const el = sentences[index];
    if (!el) return;
    const s = extractPlainText(el);
    synth.cancel();
    const u = new SpeechSynthesisUtterance(s);
    u.voice = voices.find(v=>v.name===voiceSelect.value) || voices[0];
    u.rate = parseFloat(rateInput.value) || 1;
    u.lang = "ja-JP";
    highlightSentence(index);
    u.onend = ()=>{ if (!isPaused && index < sentences.length-1){ currentSentence++; speakSentence(currentSentence); } };
    synth.speak(u);
  }

  /* ---------------------------
     Highlight & compare panel
     --------------------------- */
  function highlightSentence(index){
    sentences.forEach(s=>s.classList.remove("active-sentence"));
    allEsSentences.forEach(s=>s.classList.remove("active-sentence-es"));
    if (sentences[index]) { sentences[index].classList.add("active-sentence"); sentences[index].scrollIntoView({behavior:"smooth",block:"center"}); }
    if (allEsSentences[translationIndex]) { allEsSentences[translationIndex].classList.add("active-sentence-es"); allEsSentences[translationIndex].scrollIntoView({behavior:"smooth",block:"center"}); }
    updateComparePanel(index);
  }

  function updateComparePanel(index){
    const jp = sentences[index];
    const es = allEsSentences[translationIndex];
    document.getElementById("jp-sentence").innerHTML = jp ? jp.innerHTML : "ÔºàOraci√≥n japonesa aparecer√° aqu√≠Ôºâ";
    document.getElementById("es-sentence").textContent = es ? es.innerText : "ÔºàTraducci√≥n en espa√±ol aparecer√° aqu√≠Ôºâ";
  }
// Obtener lectura completa en hiragana usando Kuromoji
function getReadingFromKuromoji(text) {
  if (!kuromojiTokenizer || !text) return "";
  const tokens = kuromojiTokenizer.tokenize(text);
  return tokens.map(t => kanaKatakanaToHiragana(t.reading || t.surface_form)).join("");
}
  /* ---------------------------
     Controls
     --------------------------- */
  function playPause(){
    if (synth.speaking && !isPaused) { try { synth.pause(); } catch(e){} isPaused = true; }
    else if (isPaused) { try { synth.resume(); } catch(e){} isPaused = false; }
    else { if(!sentences.length){ renderSpanishFromRaw(document.getElementById("text2").innerText||""); renderJapaneseFromRaw(document.getElementById("text1").innerText||""); } currentSentence=0; isPaused=false; speakSentence(currentSentence); }
  }
  function nextSentence(){ if(currentSentence < sentences.length-1){ currentSentence++; synth.cancel(); speakSentence(currentSentence); } }
  function prevSentence(){ if(currentSentence > 0){ currentSentence--; synth.cancel(); speakSentence(currentSentence); } }
  function repeatSentence(){ synth.cancel(); speakSentence(currentSentence); }

  /* ---------------------------
     Events: clicks, keyboard, buttons
     --------------------------- */
  document.getElementById("text1").addEventListener("click", e=>{
    const clicked = e.target.closest(".sentence");
    if (!clicked) return;
    const idx = sentences.indexOf(clicked);
    if (idx!==-1){ currentSentence = idx; highlightSentence(idx); speakSentence(idx); }
  });

  document.getElementById("prev-translation").addEventListener("click", ()=>{ if(translationIndex>0) translationIndex--; updateComparePanel(currentSentence); });
  document.getElementById("next-translation").addEventListener("click", ()=>{ if(translationIndex < allEsSentences.length-1) translationIndex++; updateComparePanel(currentSentence); });
 document.getElementById("explain-jp").addEventListener("click", ()=>{
  const jp = extractPlainText(sentences[currentSentence] || {});
  if (!jp) return;

  // Obtener lectura completa (hiragana)
  const reading = getReadingFromKuromoji(jp);

  // Obtener la traducci√≥n actual del recuadro (si ya se mostr√≥)
  const translationBox = document.getElementById("es-sentence");
const translation = translationBox ? translationBox.textContent.trim() : "";

  // Registrar la expresi√≥n si no estaba
  if (!consultedExpressions.some(e => e.jp === jp)) {
    consultedExpressions.push({ jp, reading, translation });
  }

  // Abrir ChatGPT (igual que antes)
  const q = `Explica el significado de la oraci√≥n en japon√©s \"${jp}\" en espa√±ol`;
  window.open(`https://chat.openai.com/?q=${encodeURIComponent(q)}`,"_blank");
});
  document.addEventListener("keydown", e=>{
    if (e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA") return;
    if (e.key==="a"||e.key==="A"){ e.preventDefault(); prevSentence(); }
    if (e.key==="d"||e.key==="D"){ e.preventDefault(); nextSentence(); }
    if (e.key==="s"||e.key==="S"){ e.preventDefault(); repeatSentence(); }
    if (e.code==="Space"){ e.preventDefault(); playPause(); }
  });

  document.getElementById("playBtn").addEventListener("click", ()=>{ if(!sentences.length){ renderSpanishFromRaw(document.getElementById("text2").innerText||""); renderJapaneseFromRaw(document.getElementById("text1").innerText||""); } speakSentence(currentSentence||0); });
  document.getElementById("pauseBtn").addEventListener("click", ()=>{ if(synth.speaking && !isPaused){ try{ synth.pause(); }catch(e){} isPaused=true; } else if(isPaused){ try{ synth.resume(); }catch(e){} isPaused=false; } });
  document.getElementById("stopBtn").addEventListener("click", ()=>{ synth.cancel(); isPaused=false; });

  /* ---------------------------
     File inputs
     --------------------------- */
  async function handleFileInput(file, target){
    const text = await readFile(file);
    if (target==="jp") {
      await renderJapaneseFromRaw(text||"");
      allEsSentences = Array.from(document.getElementById("text2").querySelectorAll(".sentence-es"));
      translationIndex = 0;
      updateComparePanel(0);
    } else {
      renderSpanishFromRaw(text||"");
      sentences = Array.from(document.getElementById("text1").querySelectorAll(".sentence"));
      translationIndex = 0;
      updateComparePanel(0);
    }
  }
  document.getElementById("file1").addEventListener("change", e=>{ const f=e.target.files?.[0]; if(f) handleFileInput(f,"jp"); });
  document.getElementById("file2").addEventListener("change", e=>{ const f=e.target.files?.[0]; if(f) handleFileInput(f,"es"); });

/* ---------------------------
   Inicializaci√≥n
--------------------------- */
window.addEventListener("load", async () => {
  try {
    await initKuromoji();
  } catch (err) {
    console.warn("Kuromoji inicializaci√≥n fall√≥ (seguimos sin furigana):", err);
  }

  populateVoices();
  console.log("‚úÖ Lector Japon√©s - P√°gina lista. Carga archivos para probar.");

  // ü™Ñ Exportar baraja Anki al hacer clic (solo si el bot√≥n existe)
  const exportBtn = document.getElementById("export-anki");
  if (exportBtn) {
    exportBtn.addEventListener("click", async () => {
      let lines = [];

      // Palabras consultadas
      for (const w of consultedWords) {
        lines.push(`${w.kanji}\t${w.reading}<br>${w.meaning}`);
      }

      // Expresiones consultadas
      for (const e of consultedExpressions) {
        const hira = e.reading || getReadingFromKuromoji(e.jp);
        lines.push(`${e.jp}\t${hira}<br>${e.translation}`);
      }

      const content = lines.join("\n");
      const blob = new Blob([content], { type: "text/tab-separated-values;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `baraja_anki_${new Date().toISOString().split("T")[0]}.tsv`;
      a.click();
      URL.revokeObjectURL(url);
    });
  }

  // üåô MODO OSCURO / CLARO (solo si el bot√≥n existe)
  const themeToggle = document.getElementById("theme-toggle");
  if (themeToggle) {
    const saved = localStorage.getItem("themeMode") || "light";
    document.documentElement.setAttribute("data-theme", saved);
    themeToggle.textContent = saved === "dark" ? "‚òÄÔ∏è" : "üåô";

    themeToggle.addEventListener("click", () => {
      const current = document.documentElement.getAttribute("data-theme");
      const next = current === "dark" ? "light" : "dark";
      document.documentElement.setAttribute("data-theme", next);
      themeToggle.textContent = next === "dark" ? "‚òÄÔ∏è" : "üåô";
      localStorage.setItem("themeMode", next);
    });
  }
});

   // ---------------------------
  // Exportar baraja para Anki
  // ---------------------------
  document.getElementById("export-anki").addEventListener("click", async () => {
  let lines = [];

  // üîπ PALABRAS CONSULTADAS
  for (const lemma of consultedWords) {
    const entry = jishoCache[lemma] || await getTranslationFor(lemma);
    const reading = entry?.reading ? kanaKatakanaToHiragana(entry.reading) : "";
    const meanings = entry?.senses ? entry.senses.join("; ") : "(sin traducci√≥n)";
    lines.push(`${lemma}\t${reading}<br>${meanings}`);
  }

  // üîπ EXPRESIONES ANALIZADAS
  for (const exp of consultedExpressions) {
    const { jp, reading, translation } = exp;
    const hira = reading || getReadingFromKuromoji(jp);
    lines.push(`${jp}\t${hira}<br>${translation || "(sin traducci√≥n)"}`);
  }

  // üì¶ Crear y descargar archivo TSV
  const content = lines.join("\n");
  const blob = new Blob([content], { type: "text/tab-separated-values;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "baraja_anki.tsv";
  a.click();
  URL.revokeObjectURL(url);
}); 
 
  </script>
  <!-- üîò Botones superiores -->
<div id="top-buttons">
  <button id="export-anki" title="Exportar baraja">üì•</button>
  <button id="theme-toggle" title="Cambiar tema">üåô</button>
</div>
</body>
</html>
